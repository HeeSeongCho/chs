---
- name: configuration web db servers
  hosts: localhost
  gather_facts: no
  vars:
    web_tag: http-server
    web_image: project-web-wordpress
    web_hc: http-health-check
    web_template: web-tmp
    web_region1: us-central1
    web_region2: asia-northeast1
    backend_service: http-backend-svc
    http_lb: http-lb
    http_proxy: http-proxy
    http_frontend: http-frontend  
  tasks:  
    - name: create instance template
      gce_instance_template:
        name: "{{ web_template }}"
        size: n1-standard-1
        image: "{{ web_image }}"
        state: present
        project_id: "project-manageiq"
        credentials_file: "/home/$USER/project-manageiq-ee12388141f5.json"
        service_account_email: "joy-900@project-manageiq.iam.gserviceaccount.com"
        tags: "{{ web_tag }}"
        
    - local_action:
        module: gce_lb
        name: testlb    #로드밸런서 이름
        region: us-central1   #로드밸런서가 위치할 리전
        httphealthcheck_name: "{{ web_hc }}"    #health check의 이름
        httphealthcheck_port: 80
        httphealthcheck_interval: 10
        service_account_email: "joy-900@project-manageiq.iam.gserviceaccount.com"
        project_id: "project-manageiq"
        
    - name: Create MIG
      gce_mig:
        project_id: "project-manageiq"
        credentials_file: "/home/$USER/project-manageiq-ee12388141f5.json"
        service_account_email: "joy-900@project-manageiq.iam.gserviceaccount.com"
        name: "{{ web_region1 }}-wig"
        zone: "{{ web_region1 }}-a"
        state: present
        size: 1
        template: "{{ web_template }}"
        named_ports:
        - name: http
          port: 80
        recreate_instances: yes
        autoscaling:
          enabled: yes
          name: "{{ web_region1 }}-wig"
          policy:
            min_instances: 1
            max_instances: 5
            cool_down_period: 45
            load_balancing_utilization:
              target: 0.8
